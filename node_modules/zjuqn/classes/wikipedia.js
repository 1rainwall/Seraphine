const { get } = require('node-superfetch')
const Discord = require('discord.js')
const {zJuqnError} = require('../Util/zJuqnError')

  /**
   * @param {Discord.Message} options.message 
   * @param {String} [options.title] 
   * @param {Discord.ColorResolvable} options.color 
   * @param {String} options.query 
  */

class Wikipeida {

  constructor(options) {

    if (!options.color) throw new zJuqnError('[zJuqnNPM] => Error: Falta el color de los argumentos en la función de wikipedia.')
    if (typeof options.color !== 'string') throw new zJuqnError('[ERROR] => Error: ¡El color debe ser un String! en la función de wikipedia.')
    if (!options.query) throw new zJuqnError('[zJuqnNPM] => Error: Falta la consulta de los argumentos en la función de wikipedia.')
    if (typeof options.query !== 'string') throw new zJuqnError('[ERROR] => Error: ¡la consulta debe ser un String! en la función de wikipedia.')
    if (!options.message) throw new zJuqnError('[zJuqnNPM] => Error: Falta un mensaje de error en la función de wikipedia.')

    this.message = options.message
    this.color = options.color
    this.query = options.query
  }

  async fetch() {
    const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(this.query)}`

    let response;
    try {
      let { body } = await get(url)
      response = body
      
    } catch (e) {
      console.log('[zJuqnNPM] => Error: Algo salió mal con la búsqueda en Wikipedia\n' + e)
    }
    try {
      if (response.type === 'disambiguation') {
        const embedSoApi = new Discord.MessageEmbed()
          .setTitle(response.title)
          .setColor(this.color)
          .setURL(response.content_urls.desktop.page)
          .setThumbnail(response.thumbnail.source)
          .setDescription(`${response.extract} Otros enlaces para el mismo tema: [Click Aqui!](${response.content_urls.desktop.page}).`)
        this.message.reply({ embeds: [embedSoApi] }).catch()
      } else {
        const embedToApi = new Discord.MessageEmbed()
          .setTitle(response.title)
          .setColor(this.color)
          .setURL(response.content_urls.desktop.page)
          .setThumbnail(response.thumbnail.source)
          .setDescription(response.extract)
          this.message.reply({ embeds: [embedToApi] }).catch()
      }
    } catch (e) {
      this.message.reply({ embeds: [new Discord.MessageEmbed().setDescription(`:x: **|** No hay resultados para ${this.query}`).setColor("RED")] })
    }
  }
}

module.exports = Wikipeida;